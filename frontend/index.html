<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Botija Forex AI Trading Bot</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>‚ö°</text></svg>"
      type="image/svg+xml"
    />
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/components.css" />
  </head>

  <body
    class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 min-h-screen text-gray-100"
  >
    <div x-data="app()" x-init="init()" class="min-h-screen flex flex-col">
      <!-- Header/Navigation -->
      <nav class="bg-gray-950 border-b border-gray-700">
        <div
          class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
        >
          <div class="flex items-center gap-2">
            <span class="text-2xl font-bold text-green-500">‚ö°</span>
            <h1 class="text-xl font-bold">Botija Forex AI Trading Bot</h1>
          </div>
          <div class="flex items-center gap-6">
            <button
              @click="showConfigModal = true; fetchConfig()"
              class="text-gray-400 hover:text-white transition-colors"
              title="Configuration"
            >
              ‚öôÔ∏è
            </button>
            <div x-show="!loading && status" class="flex items-center gap-2">
              <span
                class="inline-block w-3 h-3 bg-green-500 rounded-full animate-pulse"
              ></span>
              <span class="text-sm text-green-400">Connected</span>
            </div>
            <div x-show="loading" class="text-blue-400 text-sm">Loading...</div>
            <div class="text-xs text-gray-500">
              Next trading cycle in:
              <span x-text="formatTime(schedulerCountdown)"></span>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-8">
        <!-- Top KPIs - Bot Status & Portfolio -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <!-- Bot Status (with Hybrid Strategy info) -->
          <div
            class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-gray-700 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-medium text-gray-400">Bot Status</div>
              <span
                class="inline-block w-3 h-3 bg-green-500 rounded-full animate-pulse"
              ></span>
            </div>
            <div class="flex items-center gap-3 mb-2">
              <span
                class="text-2xl font-bold text-green-400"
                x-text="botStatus.is_running ? 'ACTIVE' : 'INACTIVE'"
              ></span>
              <span class="px-2 py-0.5 bg-gray-700 rounded text-xs text-gray-300" x-text="schedulerStatus.trading_mode || 'DEMO'"></span>
            </div>
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-0.5 bg-purple-600/30 border border-purple-500/50 rounded text-xs font-semibold text-purple-300" x-text="botStatus.active_strategy || 'Hybrid'"></span>
              <span class="px-2 py-0.5 bg-blue-600/30 border border-blue-500/50 rounded text-xs font-semibold text-blue-300" x-text="botStatus.timeframe || 'H4'"></span>
            </div>
            <div class="text-xs text-gray-400 flex items-center gap-2">
              <span
                class="px-1.5 py-0.5 rounded"
                :class="hybridStatus.regime === 'consolidation' ? 'bg-yellow-600/30 text-yellow-300' : 'bg-green-600/30 text-green-300'"
                x-text="hybridStatus.active_strategy === 'breakout' ? 'Breakout' : 'MACD'"
              ></span>
              <span class="text-gray-500">ADX: <span x-text="hybridStatus.adx || '‚Äî'" class="text-gray-300"></span></span>
            </div>
          </div>

          <!-- NAV (Net Asset Value) -->
          <div
            class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-gray-700 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-gray-400">NAV</div>
              <span class="text-2xl">üí∞</span>
            </div>
            <div
              class="text-2xl font-bold text-cyan-400 mb-1"
              x-text="formatUSD(botStatus.nav)"
            ></div>
            <div class="text-xs text-gray-500">Net Asset Value</div>
          </div>

          <!-- Account Balance -->
          <div
            class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-gray-700 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-gray-400">Balance</div>
              <span class="text-2xl">üíµ</span>
            </div>
            <div
              class="text-2xl font-bold text-blue-400 mb-1"
              x-text="formatUSD(botStatus.balance)"
            ></div>
            <div class="text-xs text-gray-500">Available margin</div>
          </div>

          <!-- Total Unrealized P/L -->
          <div
            class="bg-gradient-to-br from-purple-900/30 to-gray-900 rounded-xl border border-purple-700/50 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-purple-300">Total P/L</div>
              <span class="text-2xl">üìà</span>
            </div>
            <div
              class="text-2xl font-bold mb-1"
              :class="totalUnrealizedPL > 0 ? 'text-green-400' : totalUnrealizedPL < 0 ? 'text-red-400' : 'text-gray-400'"
              x-text="formatUSD(totalUnrealizedPL)"
            ></div>
            <div class="text-xs text-purple-300/70" x-text="positions.length + ' open position' + (positions.length !== 1 ? 's' : '')"></div>
          </div>
        </div>

        <!-- Next Cycle & Manual Control -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
          <!-- Next Cycle Countdown -->
          <div
            class="bg-gradient-to-br from-blue-900/30 to-gray-900 rounded-xl border border-blue-700/50 p-6 shadow-lg"
          >
            <div class="text-sm font-medium text-blue-300 mb-3">
              ‚è∞ Next Trading Cycle
            </div>
            <div
              class="text-4xl font-bold text-blue-400 mb-2"
              x-text="formatTime(schedulerCountdown)"
            ></div>
            <div
              class="text-xs text-blue-300/70"
              x-text="schedulerStatus.next_run_time ? toET(schedulerStatus.next_run_time) : 'Not scheduled'"
            ></div>
          </div>

          <!-- Manual Control -->
          <div
            class="bg-gradient-to-br from-green-900/30 to-gray-900 rounded-xl border border-green-700/50 p-6 shadow-lg flex flex-col justify-center"
          >
            <button
              @click="runManualCycle()"
              :disabled="manualCycleRunning"
              :class="manualCycleRunning ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
              class="w-full px-6 py-3 rounded-lg font-bold transition-colors flex items-center justify-center gap-2"
            >
              <span x-show="!manualCycleRunning" class="text-lg">‚ñ∂Ô∏è Run Manual Cycle</span>
              <span x-show="manualCycleRunning" class="flex items-center gap-2">
                <svg
                  class="animate-spin h-5 w-5"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                Running...
              </span>
            </button>
            <div class="text-xs text-center text-green-300/70 mt-2">
              Execute cycle immediately
            </div>
          </div>
        </div>

        <!-- Trading Cycles History -->
        <div
          class="bg-gray-800 rounded-xl border border-gray-700 p-6 mb-6 shadow-lg"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>üìä</span> Trading Cycles History
            </h2>
            <button
              @click="fetchCycles()"
              class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              üîÑ Refresh
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-700/50 border-b border-gray-600">
                <tr>
                  <th class="px-3 py-2 text-left">Time</th>
                  <th class="px-3 py-2 text-left">Pair / Strategy</th>
                  <th class="px-3 py-2 text-left">Price / Indicators</th>
                  <th class="px-3 py-2 text-left">Signal</th>
                  <th class="px-3 py-2 text-left">Action</th>
                  <th class="px-3 py-2 text-right">Balance</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                <template x-for="cycle in paginatedCycles" :key="cycle.id">
                  <tr class="hover:bg-gray-700/30 transition-colors">
                    <td class="px-3 py-2 text-gray-300">
                      <div class="text-xs font-medium" x-text="toETDate(cycle.timestamp)"></div>
                      <div class="text-xs text-gray-500" x-text="toETTime(cycle.timestamp)"></div>
                      <span
                        class="px-1.5 py-0.5 rounded text-[10px] font-medium mt-0.5 inline-block"
                        :class="cycle.trigger === 'manual' ? 'bg-cyan-600/50 text-cyan-200' : 'bg-indigo-600/50 text-indigo-200'"
                        x-text="cycle.trigger === 'manual' ? '‚ö° Manual' : '‚è∞ Auto'"
                      ></span>
                    </td>
                    <td class="px-3 py-2">
                      <div class="flex flex-col gap-1">
                        <span class="px-2 py-0.5 bg-orange-600/30 border border-orange-500/50 rounded text-xs font-semibold text-orange-300 w-fit" x-text="cycle.instrument || 'EUR_USD'"></span>
                        <span class="px-2 py-0.5 bg-purple-600/30 border border-purple-500/50 rounded text-xs font-semibold text-purple-300 w-fit" x-text="cycle.strategy || 'Legacy'"></span>
                      </div>
                    </td>
                    <td class="px-3 py-2">
                      <div class="font-semibold text-orange-400 text-sm" x-text="formatPrice(cycle.price)"></div>
                      <div class="text-xs text-gray-400 mt-0.5">
                        <span class="text-blue-400" x-text="'E20:' + formatPrice(cycle.ema_fast)"></span>
                        <span class="text-purple-400 ml-1" x-text="'E50:' + formatPrice(cycle.ema_slow)"></span>
                        <span class="text-cyan-400 ml-1" x-text="'E200:' + formatPrice(cycle.ema_trend)"></span>
                      </div>
                    </td>
                    <td class="px-3 py-2">
                      <div class="flex items-center gap-1">
                        <span
                          class="px-2 py-0.5 rounded text-xs font-bold"
                          :class="{
                            'bg-green-600': cycle.ai_signal === 'BUY',
                            'bg-red-600': cycle.ai_signal === 'SELL',
                            'bg-gray-600': cycle.ai_signal === 'NEUTRAL' || cycle.ai_signal === 'HOLD'
                          }"
                          x-text="cycle.ai_signal"
                        ></span>
                        <span class="text-xs text-gray-400" x-text="(cycle.ai_confidence * 100).toFixed(0) + '%'"></span>
                      </div>
                      <div class="text-xs text-gray-500 mt-0.5 max-w-[150px] truncate" x-text="cycle.ai_reason" x-show="cycle.ai_reason" :title="cycle.ai_reason"></div>
                    </td>
                    <td class="px-3 py-2">
                      <span
                        class="px-2 py-0.5 rounded text-xs font-bold"
                        :class="{
                          'bg-green-600': cycle.action === 'BOUGHT' || cycle.action === 'LONGED' || cycle.action === 'LONG',
                          'bg-red-600': cycle.action === 'SOLD' || cycle.action === 'SHORTED' || cycle.action === 'SHORT',
                          'bg-gray-600': cycle.action === 'SKIP' || cycle.action === 'HOLD',
                          'bg-red-800': cycle.action === 'ERROR' || (cycle.action && cycle.action.includes('FAILED'))
                        }"
                        x-text="cycle.action"
                      ></span>
                      <div class="text-xs text-gray-500 mt-0.5" x-text="cycle.execution_time_ms + 'ms'"></div>
                    </td>
                    <td class="px-3 py-2 text-right">
                      <div class="text-sm text-blue-400 font-medium" x-text="formatUSD(cycle.balance)"></div>
                      <div class="text-xs text-gray-500" x-text="formatPosition(cycle.position_units)"></div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div
              x-show="cycles.length === 0"
              class="text-gray-500 text-center py-8"
            >
              No trading cycles recorded yet
            </div>

            <!-- Pagination Controls -->
            <div
              x-show="cycles.length > 0"
              class="mt-6 flex items-center justify-between border-t border-gray-700 pt-4"
            >
              <div class="text-sm text-gray-400">
                Showing <span x-text="((cyclesCurrentPage - 1) * cyclesItemsPerPage) + 1"></span>
                to <span x-text="Math.min(cyclesCurrentPage * cyclesItemsPerPage, cycles.length)"></span>
                of <span x-text="cycles.length"></span> cycles
              </div>
              <div class="flex items-center gap-2">
                <button
                  @click="cyclesPrevPage()"
                  :disabled="cyclesCurrentPage === 1"
                  :class="cyclesCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-600'"
                  class="px-4 py-2 bg-gray-700 rounded-lg text-sm font-semibold transition-colors"
                >
                  ‚Üê Previous
                </button>
                <div class="text-sm text-gray-400">
                  Page <span x-text="cyclesCurrentPage"></span> of <span x-text="cyclesTotalPages"></span>
                </div>
                <button
                  @click="cyclesNextPage()"
                  :disabled="cyclesCurrentPage === cyclesTotalPages"
                  :class="cyclesCurrentPage === cyclesTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-600'"
                  class="px-4 py-2 bg-gray-700 rounded-lg text-sm font-semibold transition-colors"
                >
                  Next ‚Üí
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Positions -->
        <div
          class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-yellow-700/50 p-6 mb-6 shadow-lg"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>üìç</span> Active Positions
            </h2>
            <button
              @click="fetchPositions()"
              class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              üîÑ Refresh
            </button>
          </div>
          <div x-show="positions.length > 0" class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-700/50 border-b border-gray-600">
                <tr>
                  <th class="px-3 py-3 text-left">Instrument</th>
                  <th class="px-3 py-3 text-left">Side</th>
                  <th class="px-3 py-3 text-right">Units</th>
                  <th class="px-3 py-3 text-right">Entry</th>
                  <th class="px-3 py-3 text-right">Current</th>
                  <th class="px-3 py-3 text-right">P/L</th>
                  <th class="px-3 py-3 text-left">Duration</th>
                  <th class="px-3 py-3 text-right">SL</th>
                  <th class="px-3 py-3 text-right">TP</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                <template x-for="(pos, index) in positions" :key="'pos-' + index">
                  <tr class="hover:bg-gray-700/30 transition-colors">
                    <td class="px-3 py-3">
                      <div class="font-bold text-orange-400" x-text="pos.instrument"></div>
                      <div class="text-xs text-gray-500" x-text="'#' + pos.trade_id"></div>
                    </td>
                    <td class="px-3 py-3">
                      <span
                        :class="pos.side === 'LONG' ? 'bg-green-600' : 'bg-red-600'"
                        class="px-2 py-1 rounded text-xs font-bold"
                        x-text="pos.side"
                      ></span>
                    </td>
                    <td class="px-3 py-3 text-right text-blue-400 font-semibold" x-text="formatNumber(pos.units, 0)"></td>
                    <td class="px-3 py-3 text-right text-gray-200" x-text="formatPrice(pos.entry_price)"></td>
                    <td class="px-3 py-3 text-right text-cyan-400" x-text="formatPrice(pos.current_price)"></td>
                    <td class="px-3 py-3 text-right">
                      <div
                        :class="pos.unrealized_pl >= 0 ? 'text-green-400' : 'text-red-400'"
                        class="font-bold"
                        x-text="formatUSD(pos.unrealized_pl)"
                      ></div>
                      <div class="text-xs text-gray-400" x-text="pos.pl_pips + ' pips'"></div>
                    </td>
                    <td class="px-3 py-3">
                      <div class="text-yellow-400 font-semibold" x-text="pos.duration"></div>
                      <div class="text-xs text-gray-500" x-text="formatDateTime(pos.open_time)"></div>
                    </td>
                    <td class="px-3 py-3 text-right">
                      <span x-show="pos.stop_loss" class="text-red-400" x-text="formatPrice(pos.stop_loss)"></span>
                      <span x-show="!pos.stop_loss" class="text-gray-600">‚Äî</span>
                    </td>
                    <td class="px-3 py-3 text-right">
                      <span x-show="pos.take_profit" class="text-green-400" x-text="formatPrice(pos.take_profit)"></span>
                      <span x-show="!pos.take_profit" class="text-gray-600">‚Äî</span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div
            x-show="positions.length === 0"
            class="text-gray-500 text-center py-8"
          >
            <div class="text-4xl mb-3">üì≠</div>
            <div class="text-lg">No active positions</div>
            <div class="text-sm mt-2">Waiting for trade signal...</div>
          </div>
        </div>

        <!-- Recent Trades -->
        <div
          class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-orange-700/50 p-6 mb-6 shadow-lg"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>üí∞</span> Recent Trades
            </h2>
            <button
              @click="syncTrades(); refreshStatus()"
              :disabled="syncing"
              class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              <span x-show="!syncing">üîÑ Refresh</span>
              <span x-show="syncing">‚è≥ Syncing...</span>
            </button>
          </div>
          <div x-show="trades.length > 0" class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-700/50 border-b border-gray-600">
                <tr>
                  <th class="px-4 py-3 text-left">Trade ID</th>
                  <th class="px-4 py-3 text-left">Type</th>
                  <th class="px-4 py-3 text-left">Entry Price</th>
                  <th class="px-4 py-3 text-left">Exit Price</th>
                  <th class="px-4 py-3 text-left">Units</th>
                  <th class="px-4 py-3 text-left">P/L</th>
                  <th class="px-4 py-3 text-left">Status</th>
                  <th class="px-4 py-3 text-left">Date</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                <template
                  x-for="(trade, index) in trades"
                  :key="'trade-' + index"
                >
                  <tr class="hover:bg-gray-700/30 transition-colors">
                    <td
                      class="px-4 py-3 font-mono text-xs text-gray-400"
                      x-text="trade.trade_id"
                    ></td>
                    <td class="px-4 py-3">
                      <span
                        :class="trade.order_type === 'BUY' ? 'bg-green-600' : 'bg-red-600'"
                        class="px-2 py-1 rounded text-xs font-bold"
                        x-text="trade.order_type"
                      >
                      </span>
                    </td>
                    <td
                      class="px-4 py-3 text-green-400 font-semibold"
                      x-text="trade.entry_price ? formatPrice(trade.entry_price) : 'N/A'"
                    ></td>
                    <td
                      class="px-4 py-3 text-blue-400 font-semibold"
                      x-text="trade.exit_price ? formatPrice(trade.exit_price) : '-'"
                    ></td>
                    <td
                      class="px-4 py-3 font-mono text-xs"
                      x-text="trade.units ? formatNumber(Math.abs(trade.units), 0) + ' units' : 'N/A'"
                    ></td>
                    <td class="px-4 py-3">
                      <span
                        :class="trade.profit_loss > 0 ? 'text-green-400' : trade.profit_loss < 0 ? 'text-red-400' : 'text-gray-400'"
                        class="font-bold"
                        x-text="trade.profit_loss ? formatUSD(trade.profit_loss) : '-'"
                      >
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <span
                        :class="{
                          'bg-green-600': trade.status === 'CLOSED',
                          'bg-blue-600': trade.status === 'OPEN',
                          'bg-gray-600': trade.status === 'CANCELLED'
                        }"
                        class="px-2 py-1 rounded text-xs font-semibold"
                        x-text="trade.status"
                      >
                      </span>
                    </td>
                    <td
                      class="px-4 py-3 text-xs text-gray-400"
                      x-text="toET(trade.created_at)"
                    ></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div
            x-show="trades.length === 0"
            class="text-gray-500 text-center py-12"
          >
            <div class="text-4xl mb-3">üìä</div>
            <div class="text-lg">No trades executed yet</div>
            <div class="text-sm mt-2">Waiting for trading signals...</div>
          </div>
        </div>

        <!-- Application Logs -->
        <div
          class="bg-gray-800 rounded-xl border border-gray-700 p-6 shadow-lg"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>üìù</span> Application Logs
            </h2>
            <div class="flex gap-2">
              <select
                x-model="logLevel"
                @change="fetchLogs()"
                class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
              >
                <option value="">All Levels</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
              </select>
              <button
                @click="fetchLogs()"
                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
              >
                üîÑ Refresh
              </button>
              <a
                href="/api/v1/bot/logs/download"
                download="botija-forex.log"
                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors inline-block"
              >
                üì• Download
              </a>
            </div>
          </div>
          <div
            class="bg-gray-900 rounded-lg p-4 font-mono text-xs max-h-96 overflow-y-auto border border-gray-700"
            id="logs-container"
          >
            <template x-for="(log, index) in logs" :key="index">
              <div
                class="py-1 border-b border-gray-800 hover:bg-gray-800/50 transition-colors"
              >
                <span
                  class="text-gray-500"
                  x-text="toETTime(log.timestamp)"
                ></span>
                <span
                  :class="{
                    'text-blue-400': log.level === 'INFO',
                    'text-yellow-400': log.level === 'WARNING',
                    'text-red-400': log.level === 'ERROR',
                    'text-gray-400': !['INFO', 'WARNING', 'ERROR'].includes(log.level)
                  }"
                  x-text="'[' + log.level + ']'"
                ></span>
                <span class="text-gray-300" x-text="log.message"></span>
              </div>
            </template>
            <div
              x-show="logs.length === 0"
              class="text-gray-500 text-center py-8"
            >
              No logs available
            </div>
          </div>
        </div>
      </main>

      <!-- Config Modal -->
      <div
        x-show="showConfigModal"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black/70 flex items-center justify-center z-50"
        @click.self="showConfigModal = false"
      >
        <div class="bg-gray-800 rounded-xl border border-gray-600 p-6 w-full max-w-lg mx-4 shadow-2xl">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>‚öôÔ∏è</span> Configuration
            </h2>
            <button @click="showConfigModal = false" class="text-gray-400 hover:text-white text-2xl">&times;</button>
          </div>

          <div x-show="!config" class="text-center py-8 text-gray-400">Loading...</div>

          <div x-show="config" class="space-y-6">
            <!-- Account Section -->
            <div>
              <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Account</h3>
              <div class="grid grid-cols-3 gap-4">
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Account ID</div>
                  <div class="font-mono text-sm" x-text="config?.account?.account_id"></div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Environment</div>
                  <div class="font-semibold" :class="config?.account?.environment === 'LIVE' ? 'text-red-400' : 'text-green-400'" x-text="config?.account?.environment"></div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Timeframe</div>
                  <div class="font-semibold text-blue-400" x-text="config?.account?.granularity"></div>
                </div>
              </div>
            </div>

            <!-- Strategy Section -->
            <div>
              <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Strategy</h3>
              <div class="bg-gray-700/50 rounded-lg p-3 inline-block">
                <div class="text-xs text-gray-400">Active Strategy</div>
                <div class="font-semibold text-purple-400" x-text="config?.strategy?.name"></div>
                <div class="text-xs text-gray-500 mt-1" x-text="'ID: ' + config?.strategy?.id"></div>
              </div>
            </div>

            <!-- Trading Section -->
            <div>
              <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Trading</h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Instrument</div>
                  <div class="font-semibold text-cyan-400" x-text="config?.trading?.instrument"></div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Leverage</div>
                  <div class="font-semibold text-yellow-400" x-text="config?.trading?.leverage + ':1'"></div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Trade Amount</div>
                  <div class="font-semibold" x-text="config?.trading?.trade_amount_percent + '% margin'"></div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Min Reserve</div>
                  <div class="font-semibold" x-text="config?.trading?.min_balance_percent + '%'"></div>
                </div>
              </div>
            </div>

            <!-- Risk Section -->
            <div>
              <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Risk Management</h3>
              <div class="grid grid-cols-3 gap-4">
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Stop Loss</div>
                  <div class="font-semibold text-red-400" x-text="config?.risk?.stop_loss_pips + ' pips'"></div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Take Profit</div>
                  <div class="font-semibold text-green-400" x-text="config?.risk?.take_profit_pips + ' pips'"></div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3">
                  <div class="text-xs text-gray-400">Trailing Stop</div>
                  <div class="font-semibold text-purple-400" x-text="config?.risk?.trailing_stop_pips + ' pips'"></div>
                </div>
              </div>
            </div>

            <!-- Scheduler Section -->
            <div>
              <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Scheduler</h3>
              <div class="bg-gray-700/50 rounded-lg p-3 inline-block">
                <div class="text-xs text-gray-400">Interval</div>
                <div class="font-semibold text-blue-400" x-text="'Every ' + config?.scheduler?.interval_hours + ' hours'"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="border-t border-gray-700 bg-gray-950 mt-8">
        <div
          class="max-w-7xl mx-auto px-4 py-4 text-center text-sm text-gray-500"
        >
          Botija Forex AI Trading Bot v1.0.0 | Last update:
          <span x-text="toETTime(lastUpdate)"></span>
        </div>
      </footer>
    </div>

    <script>
      function app() {
        return {
          loading: true,
          status: null,
          schedulerCountdown: 0,
          showConfigModal: false,
          config: null,
          // Strategies
          strategies: [],
          botStatus: {
            is_running: false,
            balance: 0,
            nav: 0,
            position_units: 0,
            unrealized_pl: 0,
            instrument: 'EUR_USD'
          },
          trades: [],
          cycles: [],
          cyclesCurrentPage: 1,
          cyclesItemsPerPage: 5,
          schedulerStatus: {
            running: false,
            seconds_until_next: 0,
            next_run_time: null,
            last_cycle_result: null,
            trading_mode: 'DEMO'
          },
          logs: [],
          logLevel: '',
          manualCycleRunning: false,
          syncing: false,
          lastUpdate: new Date().toISOString(),
          positions: [],
          totalUnrealizedPL: 0,
          hybridStatus: {
            adx: 0,
            adx_threshold: 30,
            regime: 'unknown',
            active_strategy: 'hybrid'
          },

          // Format seconds to Xh Xm (no seconds for cleaner display)
          formatTime(seconds) {
            if (seconds <= 0) return "0h 0m";

            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);

            return `${hours}h ${mins}m`;
          },

          // Convert UTC timestamp to ET (New York timezone)
          toET(timestamp) {
            if (!timestamp) return "";
            // Ensure timestamp is treated as UTC if no timezone info
            let date = new Date(timestamp);
            if (typeof timestamp === 'string' && !timestamp.includes('Z') && !timestamp.includes('+')) {
              date = new Date(timestamp + 'Z');
            }
            return date.toLocaleString("en-US", {
              timeZone: "America/New_York",
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: true,
            });
          },

          toETTime(timestamp) {
            if (!timestamp) return "";
            // Ensure timestamp is treated as UTC if no timezone info
            let date = new Date(timestamp);
            if (!timestamp.includes('Z') && !timestamp.includes('+')) {
              date = new Date(timestamp + 'Z');
            }
            return date.toLocaleTimeString("en-US", {
              timeZone: "America/New_York",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: true,
            });
          },

          // Format number with commas
          formatNumber(num, decimals = 2) {
            if (num == null || isNaN(num)) return "0";
            return parseFloat(num).toLocaleString("en-US", {
              minimumFractionDigits: decimals,
              maximumFractionDigits: decimals,
            });
          },

          // Format USD currency
          formatUSD(amount) {
            if (amount == null || isNaN(amount)) return "$0.00";
            return "$" + this.formatNumber(amount, 2);
          },

          // Format forex price (5 decimals)
          formatPrice(price) {
            if (price == null || isNaN(price)) return "0.00000";
            return parseFloat(price).toFixed(5);
          },

          // Format date time (OANDA format to local)
          formatDateTime(isoString) {
            if (!isoString) return "";
            try {
              const date = new Date(isoString);
              return date.toLocaleString("en-US", {
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit"
              });
            } catch (e) {
              return "";
            }
          },

          // Convert UTC timestamp to ET date only
          toETDate(timestamp) {
            if (!timestamp) return "";
            // Ensure timestamp is treated as UTC if no timezone info
            let date = new Date(timestamp);
            if (!timestamp.includes('Z') && !timestamp.includes('+')) {
              date = new Date(timestamp + 'Z');
            }
            return date.toLocaleDateString("en-US", {
              timeZone: "America/New_York",
              month: "short",
              day: "2-digit",
            });
          },

          // Format position units
          formatPosition(units) {
            if (units == null || units === 0) return "FLAT";
            const sign = units > 0 ? "LONG " : "SHORT ";
            return sign + this.formatNumber(Math.abs(units), 0) + " units";
          },

          // Pagination for cycles
          get paginatedCycles() {
            const start = (this.cyclesCurrentPage - 1) * this.cyclesItemsPerPage;
            const end = start + this.cyclesItemsPerPage;
            return this.cycles.slice(start, end);
          },

          get cyclesTotalPages() {
            return Math.ceil(this.cycles.length / this.cyclesItemsPerPage) || 1;
          },

          cyclesNextPage() {
            if (this.cyclesCurrentPage < this.cyclesTotalPages) {
              this.cyclesCurrentPage++;
            }
          },

          cyclesPrevPage() {
            if (this.cyclesCurrentPage > 1) {
              this.cyclesCurrentPage--;
            }
          },

          async fetchStrategies() {
            try {
              const response = await fetch('/api/v1/market/strategies');
              if (response.ok) {
                this.strategies = await response.json();
                // Siempre inicializar con la primera estrategia
                if (this.strategies.length > 0) {
                  this.backtestStrategy = this.strategies[0].id;
                }
              }
            } catch (error) {
              console.error('Error fetching strategies:', error);
              // Fallback
              this.strategies = [
                { id: 'triple_ema', name: 'Triple EMA' },
                { id: 'rsi_ema200', name: 'RSI + EMA200' }
              ];
            }
          },

          async init() {
            await this.fetchStrategies();
            await this.refreshStatus();
            await this.fetchLogs();
            await this.fetchCycles();
            await this.fetchPositions();
            await this.fetchHybridStatus();

            // Refresh status every 5 seconds (includes countdown)
            setInterval(() => this.refreshStatus(), 5000);

            // Refresh cycles every 10 seconds
            setInterval(() => this.fetchCycles(), 10000);

            // Refresh positions every 30 seconds
            setInterval(() => this.fetchPositions(), 30000);

            // Refresh hybrid status every 5 minutes
            setInterval(() => this.fetchHybridStatus(), 300000);
          },

          async fetchHybridStatus() {
            try {
              const resp = await fetch("/api/v1/market/hybrid-status/EUR_USD?timeframe=H4");
              if (resp.ok) {
                const data = await resp.json();
                this.hybridStatus = data.status || {
                  adx: 0,
                  adx_threshold: 30,
                  regime: 'unknown',
                  active_strategy: 'hybrid'
                };
              }
            } catch (e) {
              console.warn("Error fetching hybrid status:", e);
            }
          },

          async refreshStatus() {
            try {
              // 1. Fetch scheduler status
              const schedulerResp = await fetch("/api/v1/bot/scheduler");
              if (schedulerResp.ok) {
                const schedData = await schedulerResp.json();
                this.schedulerStatus = schedData;

                // Use server countdown directly
                if (schedData.seconds_until_next != null) {
                  this.schedulerCountdown = Math.max(0, Math.floor(schedData.seconds_until_next));
                }
              }

              // 2. Fetch dashboard status
              const dashResp = await fetch("/api/v1/bot/dashboard");
              if (dashResp.ok) {
                const dashboard = await dashResp.json();
                this.botStatus = {
                  is_running: dashboard.is_running || dashboard.status !== 'not_initialized',
                  balance: parseFloat(dashboard.balance) || 0,
                  nav: parseFloat(dashboard.nav) || 0,
                  position_units: parseInt(dashboard.position_units) || 0,
                  unrealized_pl: parseFloat(dashboard.unrealized_pl) || 0,
                  instrument: dashboard.instrument || 'EUR_USD'
                };
                this.status = dashboard;

                // 3. Fetch trades
                try {
                  const mode = dashboard.mode || "DEMO";
                  const tradesResp = await fetch(`/api/v1/trades?mode=${mode}&limit=50`);
                  if (tradesResp.ok) {
                    const tradesData = await tradesResp.json();
                    this.trades = Array.isArray(tradesData) ? tradesData : [];
                  }
                } catch (e) {
                  console.warn("Error fetching trades:", e);
                }
              }

              this.lastUpdate = new Date().toISOString();
              this.loading = false;
            } catch (err) {
              console.error("Error in refreshStatus:", err);
              this.loading = false;
            }
          },

          async syncTrades() {
            if (this.syncing) return;

            this.syncing = true;
            try {
              const response = await fetch("/api/v1/trades/sync", {
                method: "POST",
              });
              const result = await response.json();

              if (result.success) {
                console.log(`‚úÖ Synced ${result.synced} trades from OANDA`);
                await this.refreshStatus();
              } else {
                console.error("‚ùå Sync failed:", result.error);
              }
            } catch (err) {
              console.error("Error syncing trades:", err);
            } finally {
              this.syncing = false;
            }
          },

          async runManualCycle() {
            if (this.manualCycleRunning) return;

            this.manualCycleRunning = true;
            try {
              const response = await fetch("/api/v1/bot/cycle", {
                method: "POST",
              });
              const result = await response.json();

              if (result.success || result.message) {
                console.log("‚úÖ Manual cycle completed:", result);
                await this.refreshStatus();
                await this.fetchCycles();
              } else {
                console.error("‚ùå Manual cycle failed:", result);
              }
            } catch (err) {
              console.error("Error running manual cycle:", err);
            } finally {
              this.manualCycleRunning = false;
            }
          },

          async fetchConfig() {
            try {
              const response = await fetch("/api/v1/bot/config");
              if (response.ok) {
                this.config = await response.json();
              }
            } catch (err) {
              console.error("Error fetching config:", err);
            }
          },

          async fetchCycles() {
            try {
              const response = await fetch("/api/v1/cycles/?limit=100");
              if (response.ok) {
                const data = await response.json();
                this.cycles = Array.isArray(data) ? data : [];
              }
            } catch (err) {
              console.error("Error fetching cycles:", err);
            }
          },

          async fetchPositions() {
            try {
              const response = await fetch("/api/v1/bot/positions");
              if (response.ok) {
                const data = await response.json();
                this.positions = data.positions || [];
                // Calculate total unrealized P/L from all positions
                this.totalUnrealizedPL = this.positions.reduce(
                  (sum, pos) => sum + (pos.unrealized_pl || 0), 0
                );
              }
            } catch (err) {
              console.error("Error fetching positions:", err);
            }
          },

          async fetchLogs() {
            try {
              const url = this.logLevel
                ? `/api/v1/bot/logs?limit=100&level=${this.logLevel}`
                : "/api/v1/bot/logs?limit=100";

              const response = await fetch(url);
              if (response.ok) {
                const data = await response.json();
                this.logs = data.logs || [];

                // Auto-scroll to bottom
                setTimeout(() => {
                  const container = document.getElementById("logs-container");
                  if (container) {
                    container.scrollTop = container.scrollHeight;
                  }
                }, 100);
              }
            } catch (err) {
              console.error("Error fetching logs:", err);
            }
          },
        };
      }
    </script>

    <!-- Component Scripts -->
    <script src="./stores/auth.js"></script>
    <script src="./stores/app.js"></script>
    <script src="./utils/api.js"></script>
    <script src="./components/ui/toast.js"></script>
    <script src="./components/ui/modal.js"></script>
    <script src="./components/navigation/navbar.js"></script>
  </body>
</html>
